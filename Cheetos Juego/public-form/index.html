<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Form</title>
  <!-- estilos de bootstrap -->
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">

  <!-- script del jQuery  -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>

  <!-- estilos de las fuentes -->
  <link rel="preload"
    href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,400;0,700;1,400;1,700&display=swap&display=swap"
    as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,400;0,700;1,400;1,700&display=swap&display=swap">
  </noscript>
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css">
  <link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">

  <!-- scripts de p5js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.8.0/p5.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.8.0/addons/p5.sound.js"></script>

  <!-- script de socket.io -->
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"
    integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k"
    crossorigin="anonymous"></script>

  <!-- scrip del dns -->
  <script>
    const getDNS = "<%= DNS %>"
  </script>
</head>

<body>
  <!--Seccion de los puntos-->
  <section data-bs-version="5.1" class="header10 cid-tXd9IFeOyD" id="Menu1-b">
    <nav class="navbar navbar-dropdown navbar-expand-lg">
    </nav>
    <div class="align-center container-fluid">
      <div class="row justify-content-center">
        <div class="col-md-12 col-lg-9">
          <br>
          <br>
          <h1 class="mbr-section-title mbr-fonts-style mb-3 display-1"><strong>¡Time out!</strong></h1>
          <div class="mbr-section-head" style="color:#fff">
            <br>
            <br>
            <h5 class="mbr-section-subtitle mbr-fonts-style align-center mb-0 mt-2 display-5">your final
              score</h5>
            <br>
            <br>
            <h5 class="mbr-section-subtitle mbr-fonts-style align-center mb-0 mt-2 display-1" id="scoreContent">
              <!-- pinta el puntaje de forma dinamica -->
            </h5>
            <br>
            <br>
            <h5 class="mbr-section-subtitle mbr-fonts-style align-center mb-0 mt-2 display-5">Fulfill the
              following requirements to claim your prize.</h5>
          </div>
          <div class="mbr-section-btn mt-3">
            <div style="height: 100px;"></div>
            <a class="btn btn-primary" href="#Menu1-c" id="llama_Menu2">Continue</a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--fin Seccion de los puntos-->

  <!-- Seccion del formulario -->
  <section data-bs-version="5.1" class="header10 cid-tXd06pDC6c" id="Menu1-c">
    <nav class="navbar2 navbar-dropdown navbar-expand-lg">
    </nav>

    <div class="align-center container-fluid">
      <div class="row justify-content-center">
        <div class="col-md-12 col-lg-9">
          <h1 class="mbr-section-title mbr-fonts-style mb-3 display-1">
            <strong>!Thanks for Playing</strong>
          </h1>
          <div class="image-wrap mt-4" style="display: flex;text-align: center;">
            <img src="https://i.pinimg.com/originals/d8/a1/94/d8a194a3f2806679a50e37778e487396.png" alt="google-image"
              title="" style="width:50%;margin:0px auto">
          </div>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10" style="color:#fff">
          <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Congratulations you have won some
            Cheetos, first we need some information and you can claim your prize.</h4>
          <p class="mbr-text mbr-fonts-style display-7"></p>
        </div>
      </div>
    </div>

    <div class="align-center container-fluid">
      <div class="row justify-content-center mt-4">
        <div class="col-lg-8 mx-auto mbr-form" data-form-type="formoid">
          <form action="" method="POST" class="mbr-form form-with-styler mx-auto" data-form-title="Form Name">
            <div class="row">
              <div hidden="hidden" data-form-alert="" class="alert alert-success col-12">Thanks for
                filling out the form!</div>
              <div hidden="hidden" data-form-alert-danger="" class="alert alert-danger col-12">
                Oops...! some problem!
              </div>
            </div>
            <div class="dragArea row">

              <div class="col-lg-12 col-md-12 col-sm-12 form-group mb-3" data-for="email">
                <input type="email" name="email" placeholder="Email" data-form-field="email" class="form-control"
                  value="" id="email">
              </div>
              <div data-for="username" class="col-lg-12 col-md-12 col-sm-12 form-group mb-3">
                <input type="text" name="username" placeholder="username" data-form-field="username"
                  class="form-control" value="" id="username">
              </div>
              <div class="mbr-section-btn mt-3">
                <a class="btn btn-primary" id="llama_Menu3" href="#Menu1-d">Continue</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
  <!-- Fin de seccion del formulario -->
  

  <!-- Conexión de Firebase -->
  

  <script type="module">
    // Import socket to listen or send messages using events.
    const laurl = `http://${window.location.hostname}:5051`;
    let socket = io(laurl, { path: "/real-time" });

    // Firebase
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, push } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDwtT-vcCXTQ3MwO4XeqdyMtvvOS8bXE_I",
      authDomain: "database-cheetos.firebaseapp.com",
      projectId: "database-cheetos",
      storageBucket: "database-cheetos.appspot.com",
      messagingSenderId: "690480840919",
      appId: "1:690480840919:web:8dbe10d8ee7ff2acd03092",
      measurementId: "G-SVJMVS2V9K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    //get ref to database services
    const db = getDatabase(app);

    document.getElementById("llama_Menu3").addEventListener('click', function (e) {
      e.preventDefault();

      const usernameValue = document.getElementById("username").value;
      const emailValue = document.getElementById("email").value;

      if (usernameValue.trim() === "" || emailValue.trim() === "") {
        alert("Please complete the fields");
        return; // Detiene la ejecución si los campos están vacíos
      }

      // Obtiene el puntaje almacenado en localStorage
      const puntaje = localStorage.getItem('puntaje');

      // Genera una nueva referencia con un ID único
      const newUserRef = push(ref(db, 'user'));

      set(newUserRef, {
        username: usernameValue,
        email: emailValue,
        score: puntaje
      });

      alert("Login Successful! (check console log)");

      // Borra el puntaje almacenado después de enviarlo
      localStorage.removeItem('puntaje');

      const dbRef = ref(getDatabase());

      const usersRef = child(dbRef, 'user');

      // Obtener los datos de todos los usuarios
      get(usersRef).then((snapshot) => {
        if (snapshot.exists()) {
          // Recorremos todos los nodos de usuarios
          snapshot.forEach((childSnapshot) => {
            const userId = childSnapshot.key; // Obtener el ID único de cada usuario
            const userData = childSnapshot.val(); // Datos del usuario

            // Acceder a los campos específicos que deseas obtener
            const usernameData = userData.username;
            const scoreData = userData.score;

            const dataRanking = [usernameData, scoreData]
            socket.emit("dataScoreRanking", dataRanking)
          })

        } else {
          console.log("No data available");
        }
      }).catch((error) => {
        console.error(error);
      });

      // Cambio a Menu1-d después de completar la escritura en la base de datos
      $("#Menu1-a").css("display", "none");
      $("#Menu1-b").css("display", "none");
      $("#Menu1-c").css("display", "none");
    });

    // funcion para ocultar y mostrar las pantallas necesarias condicionado si los inputs estan vacios o no
    $(document).ready(function () {
      const usernameValue = document.getElementById("username").value;
      const emailValue = document.getElementById("email").value;

      // Funcion para condicionar el cambio de pantalla si los campos están vacíos
      $("#llama_Menu3").on("click", function () {
        if (usernameValue.trim() === "" || emailValue.trim() === "") {
          return;
        }
      });

      $("#llama_Menu2").on("click", function () {
        $("#Menu1-c").css("display", "block");
        $("#Menu1-a").css("display", "none");
        $("#Menu1-b").css("display", "none");
        $("#Menu1-d").css("display", "none");
      })
    });
  </script>

  <script src="./phone.js"></script>
</body>

</html>